<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Batman1788 Menu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- å¯é€‰ï¼šGoogle Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-5DBPBMP3K1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-5DBPBMP3K1');
  </script>

  <style>
    :root{
      --bat-black:#18191b;
      --bat-card:rgba(35,36,39,.90);
      --bat-gold:#ffe02e;
      --accent:#ffe02e;
      --err:#ff5555;
      --ok:#4cd964;
    }

    *{ box-sizing:border-box; }
    body{ margin:0; background:var(--bat-black); color:#fff; font-family:'Segoe UI','PingFang SC','Microsoft YaHei',Arial,sans-serif; }
    a{ color:var(--bat-gold); }

    .header{
      padding:14px 0 7px; text-align:center; font-size:1.25em; font-weight:800; letter-spacing:2px;
      background:var(--bat-black); color:var(--bat-gold);
      text-shadow:0 2px 24px #000, 0 1px 0 #fff3; border-bottom:1.5px solid #2c2c2e;
      position:sticky; top:0; z-index:9;
    }

    .marquee-wrap{ background:#2a2927; border-bottom:1.2px solid #282828; overflow:hidden; position:sticky; top:0; z-index:22; height:38px; }
    .marquee-text{ color:var(--bat-gold); font-size:1.03em; font-weight:600; line-height:38px; white-space:nowrap; will-change:transform; text-shadow:0 1px 10px #0006; }

    .menu-wrap{ max-width:530px; margin:0 auto; padding:18px 0 120px; }

    .menu-item{
      display:flex; background:var(--bat-card); border-radius:18px; margin:0 12px 18px; padding:13px 12px 18px;
      border:1.2px solid var(--bat-gold); box-shadow:0 3px 14px #ffe02e1b, 0 0 0 1.6px #ffe02e33; transition:.15s; position:relative; overflow:hidden;
    }
    .menu-item::before{
      content:""; position:absolute; inset:0;
      background:url('https://raw.githubusercontent.com/ha05di/batman1788shop/main/logo.png') center/85% no-repeat;
      opacity:.23; pointer-events:none;
    }
    .menu-item>*{ position:relative; z-index:1; }
    .menu-img{
      width:68px; height:68px; border-radius:13px; object-fit:cover; background:#252323; margin-right:13px;
      border:1.3px solid var(--bat-gold); box-shadow:0 2px 10px #ffe02e3a; cursor:pointer; transition:box-shadow .18s; flex-shrink:0;
    }
    .menu-img:hover{ box-shadow:0 4px 20px #ffe02ea0; }
    .menu-info{ flex:1; min-width:0; display:flex; flex-direction:column; }
    .menu-name{ font-size:1.15em; font-weight:700; margin-bottom:2.5px; color:var(--bat-gold); display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
    .menu-badge{ background:linear-gradient(90deg,#ffe02e,#ffc400); color:#111; border-radius:9px; font-size:.83em; font-weight:600; padding:2px 9px; box-shadow:0 1px 5px #ffe02e44; }
    .menu-type{ background:#303030; color:var(--bat-gold); font-size:.8em; border-radius:7px; padding:2px 8px; border:1px solid #ffe02e2c; }
    .menu-title{ color:var(--bat-gold); font-size:.95em; margin-right:4px; }
    .menu-thccbd{ color:#ffe02e; font-size:.97em; font-weight:500; }
    .menu-desc{ font-size:.97em; color:#f8f6c7; margin-top:7px; line-height:1.48; text-shadow:0 1px 4px #1a17084f; }
    .menu-bottom-prices{ display:flex; gap:10px; flex-wrap:wrap; margin-top:14px; }
    .menu-spec{ background:#2d2c22; color:var(--bat-gold); font-size:1.01em; border-radius:7px; padding:6px 12px; border:1.1px solid var(--bat-gold); box-shadow:0 1px 6px #ffe02e22; font-weight:900; cursor:pointer; }
    .menu-price{ color:#ffe02e; font-weight:900; font-size:1.02em; margin-left:3px; }

    /* å”®ç½„çš„æŒ‰é’®ç½®ç°ã€ä¸å¯ç‚¹ */
    .menu-spec[disabled]{
      opacity:.55;
      cursor:not-allowed;
      filter:grayscale(0.3);
      border-color:#666;
      box-shadow:none;
    }

    /* åº•éƒ¨è´­ç‰©è½¦æ¡ */
    .cart-bar{
      position:fixed; left:0; right:0; bottom:0; z-index:50; background:#101114; border-top:1px solid #2c2c2e; padding:10px 14px;
      display:flex; align-items:center; justify-content:center; gap:10px;
    }
    .cart-info{ color:#fff; font-weight:700; }
    .cart-btn{ background:var(--accent); color:#111; border:none; padding:10px 16px; border-radius:10px; font-weight:900; cursor:pointer; }
    .cart-btn:disabled{ opacity:.5; cursor:not-allowed; }

    /* ç»“ç®—å¼¹çª—ï¼ˆè‡ªé€‚åº”ï¼Œå°å±åªçºµå‘æ»šåŠ¨ï¼‰ */
    .checkout-bg{
      position:fixed; inset:0; padding:10px;
      background:rgba(0,0,0,.72); display:none; align-items:center; justify-content:center; z-index:99;
    }
    .checkout-bg.active{ display:flex; }
    .checkout{
      width:min(560px, 92vw);
      max-height:calc(100vh - 40px);
      overflow-y:auto; overflow-x:hidden; -webkit-overflow-scrolling:touch;
      background:#1f2024; border:1px solid #444; border-radius:16px; padding:16px; box-shadow:0 4px 30px #000a;
    }
    .checkout *{ min-width:0; }
    .checkout h3{ margin:4px 0 12px; color:var(--bat-gold); }

    .f{ display:flex; gap:10px; margin-bottom:10px; flex-wrap:wrap; }
    .f .i{ flex:1; }
    .i label{ display:block; font-size:.92em; color:#ddd; margin-bottom:6px; }
    .i input,.i textarea{ width:100%; background:#121316; color:#fff; border:1px solid #3a3a3a; border-radius:10px; padding:10px 12px; outline:none; }

    .checkout-actions{ display:flex; gap:10px; margin-top:10px; }
    .btn{ background:#2b2c30; color:#fff; border:1px solid #444; padding:10px 14px; border-radius:10px; cursor:pointer; }
    .btn.primary{ background:var(--accent); color:#111; border:none; font-weight:900; }
    .checkout-msg{ margin-top:8px; font-size:.95em; }
    .checkout-msg.ok{ color:var(--ok); }
    .checkout-msg.err{ color:var(--err); }

    /* è®¢å•æ‘˜è¦ */
    .order-summary{ background:#141519; border:1px solid #2f2f33; border-radius:12px; padding:10px 12px; margin:10px 0; }
    .order-summary .os-head{ font-weight:800; color:#ffe02e; margin-bottom:6px; }
    .order-summary table{ width:100%; border-collapse:collapse; font-size:.95em; table-layout:fixed; }
    .order-summary th,.order-summary td{ padding:6px 4px; border-bottom:1px dashed #2a2a2a; word-break:break-word; overflow-wrap:anywhere; }
    .order-summary th{ color:#ddd; font-weight:700; text-align:left; }
    .order-summary .ar{ text-align:right; }
    .order-summary .os-total{ display:flex; justify-content:flex-end; font-weight:900; margin-top:6px; }
    .order-summary .os-meta{ color:#bbb; font-size:.92em; margin-top:6px; line-height:1.4; }

    /* è®¢å•æ‘˜è¦-åˆ é™¤æŒ‰é’®ï¼ˆåƒåœ¾æ¡¶å›¾æ ‡ï¼‰ */
    .order-summary .rm-btn{
      background:#3a3b40; color:#fff; border:1px solid #555;
      width:32px; height:28px; border-radius:8px; cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center;
      font-size:16px; line-height:1;
    }
    .order-summary .rm-btn:hover{ background:#ff5555; border-color:#ff5555; }
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }

    /* è‡ªå–/é€è´§ å•é€‰ */
    .radio-group label{ margin-right:12px; cursor:pointer; }
    .radio-group input{ vertical-align:middle; margin-right:6px; }

    /* Promo å°å¾½ç«  */
    .promo-badge{max-width:530px;margin:8px auto 0;padding:0 12px;}
    .promo-chip{
      display:block;background:#232519;border:1px solid #ffe02e66;color:#ffe02e;
      border-radius:10px;padding:9px 12px;font-weight:800;text-shadow:0 1px 0 #0006;
    }
    .promo-chip small{display:block;color:#ddd;font-weight:600;margin-top:3px;}

    /* å›¾ç‰‡å¼¹çª— */
    .img-modal-bg{ position:fixed; inset:0; background:rgba(0,0,0,.75); display:none; justify-content:center; align-items:center; z-index:9999; }
    .img-modal-bg.active{ display:flex; }
    .img-modal-bg img{ max-width:90vw; max-height:84vh; border-radius:16px; box-shadow:0 2px 28px #000a; background:#111; }

    /* æ‚¬æµ®å®¢æœ */
    .contact-fab{
      position:fixed; right:21px; bottom:70px; z-index:60; background:#ffe02e; border-radius:50%;
      box-shadow:0 3px 18px #0006; width:52px; height:52px; display:flex; align-items:center; justify-content:center; border:none; cursor:pointer;
    }
    .contact-fab:hover{ box-shadow:0 7px 28px #ffe02e55; transform:scale(1.05); }

    .footer{ position:fixed; left:0; bottom:0; width:100vw; color:#ffc400; background:#18191b; font-size:.98em; text-align:center; padding:12px 0 9px; z-index:22; border-top:1.5px solid #2c2c2e; }

    /* æ‰“å¼€å¼¹çª—æ—¶å¯é€‰ï¼šé”å®šé¡µé¢èƒŒæ™¯æ»šåŠ¨ */
    body.modal-open{ overflow:hidden; }

    @media (max-width:700px){
      .menu-wrap{ padding:5px 0 130px; }
      .menu-item{ margin:0 3vw 15px; padding:10px 5px 18px; }
      .menu-img{ width:54px; height:54px; margin-right:7px; }
      .menu-name{ font-size:1.05em; }
    }
    @media (max-width:480px){
      .contact-fab{ right:12px; bottom:72px; width:44px; height:44px; }
      .contact-fab svg{ width:22px; height:22px; }
    }
  </style>
</head>
<body>
  <div class="header">Batman1788 Menu</div>

  <div class="marquee-wrap">
    <div id="marqueeInner" style="white-space:nowrap;display:flex;">
      <span class="marquee-text" id="marqueeText"></span>
      <span class="marquee-text" id="marqueeTextClone"></span>
    </div>
  </div>

  <!-- Promo å¾½ç«  -->
  <div id="promoBadge" class="promo-badge" style="display:none"></div>

  <!-- ç»‘å®š Telegram -->
  <div style="max-width:530px;margin:10px auto 0; padding:0 12px; text-align:center;">
    <button type="button" class="menu-spec" onclick="bindTelegram()">One-click binding Telegram</button>
  </div>

  <div class="menu-wrap" id="menu"></div>

  <!-- åº•éƒ¨è´­ç‰©è½¦æ¡ -->
  <div class="cart-bar">
    <div class="cart-info" id="cartInfo">Shopping Cart 0 Item Â· $0</div>
    <button class="cart-btn" id="checkoutBtn" onclick="openCheckout()" disabled>Check Out</button>
  </div>

  <!-- ç»“ç®—å¼¹çª— -->
  <div class="checkout-bg" id="checkoutBg">
    <div class="checkout">
      <h3>Fill in the information</h3>

      <div class="f"><div class="i">
        <label>Name</label><input id="custName" placeholder="Recipient's name" />
      </div></div>

      <!-- é…é€æ–¹å¼ -->
      <div class="f"><div class="i">
        <label>Delivery method</label>
        <div class="radio-group">
          <label><input type="radio" name="ship" value="delivery" checked> Delivery</label>
          <label><input type="radio" name="ship" value="pickup"> Pickup</label>
        </div>
      </div></div>

      <div class="f">
        <div class="i"><label>Phone No.</label><input id="custPhone" placeholder="+61 ..." /></div>
        <div class="i"><label>Address</label><input id="custAddr" placeholder="Full address" /></div>
      </div>

      <div class="f"><div class="i">
        <label>Notes (optional)</label><textarea id="custNotes" rows="3" placeholder="Example: Drop-off time / door note"></textarea>
      </div></div>

      <div id="orderSummary" class="order-summary"></div>

      <div class="checkout-actions">
        <button class="btn" onclick="closeCheckout()">Cancel</button>
        <button class="btn primary" onclick="submitOrder()">Submit Order</button>
      </div>
      <div class="checkout-msg" id="checkoutMsg"></div>
    </div>
  </div>

  <!-- æ‚¬æµ®å®¢æœ -->
  <a href="https://t.me/batman1788" target="_blank" class="contact-fab" title="Customer Service">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="#fff" style="vertical-align:middle">
      <circle cx="12" cy="12" r="12" fill="#ffe02e" />
      <path d="M17 10.5c0-.83-.67-1.5-1.5-1.5h-7C7.67 9 7 9.67 7 10.5v3c0 .83.67 1.5 1.5 1.5H9v2l3-2h3.5c.83 0 1.5-.67 1.5-1.5v-3z" fill="#18191b"/>
    </svg>
  </a>

  <!-- å›¾ç‰‡å¼¹çª— -->
  <div class="img-modal-bg" id="imgModal" onclick="this.classList.remove('active')">
    <img id="imgModalPic" src="" />
  </div>

  <div class="footer">
    Batman1788 Â© Menu |
    <a href="https://t.me/batman1788" target="_blank">Telegram Order</a>
  </div>

  <!-- å¹¿å‘Šå¼¹çª— -->
  <div class="ad-modal-bg hidden" id="adModal">
    <div class="ad-modal">
      <img id="adImg" src="" alt="Promo" />
      <button class="ad-close" type="button" onclick="window.closeAd()">Ã—</button>
    </div>
  </div>
  <style>
    .ad-modal-bg{ position:fixed; inset:0; background:rgba(0,0,0,.78); display:flex; align-items:center; justify-content:center; z-index:10000; }
    .hidden{ display:none!important; }
    .ad-modal{ position:relative; max-width:90vw; max-height:80vh; border-radius:16px; overflow:hidden; box-shadow:0 4px 25px #000a; background:#111; }
    .ad-modal img{ width:100%; height:auto; display:block; }
    .ad-close{ position:absolute; top:6px; right:6px; background:rgba(0,0,0,.6); color:#fff; border:none; border-radius:50%; width:32px; height:32px; font-size:20px; font-weight:bold; cursor:pointer; line-height:30px; }
    .ad-close:hover{ background:rgba(0,0,0,.85); }
  </style>

  <script>
    // ======= Config =======
    const API_BASE = ""; // åŒåŸŸéƒ¨ç½²ç•™ç©ºï¼›è‹¥å‰åç«¯åˆ†ç¦»ï¼Œå¡«ä½ çš„åç«¯å®Œæ•´åŸŸå
    const SHEET_ID = "1hUlRnvEy-k2Arz8SVKpRsAaBEFTyS6RDJBDfwDmM-Hs";
    const SHEET_TAB_MENU = "batmenu";
    const SHEET_TAB_NOTICE = "notice";
    const MENU_URL   = `https://opensheet.elk.sh/${SHEET_ID}/${SHEET_TAB_MENU}`;
    const NOTICE_URL = `https://opensheet.elk.sh/${SHEET_ID}/${SHEET_TAB_NOTICE}`;
    const AD_URL     = `https://opensheet.elk.sh/${SHEET_ID}/ad`;
    const PROMO_URL  = `https://opensheet.elk.sh/${SHEET_ID}/promo`;
    const PICKUP_ADDRESS = "1 Kingston St, Malvern East VIC 3145, Australia"; // â˜… è‡ªå–é»˜è®¤åœ°å€ï¼ˆæ”¹æˆä½ çš„ï¼‰

    // ======= Utils & State =======
    const cart = [];
    let activePromo = null; // å‘½ä¸­çš„æ´»åŠ¨ï¼ˆè‹¥æœ‰ï¼‰

    const CURRENCY = "$";
    // æ˜¾ç¤ºä¸ºæ•´æ•°ï¼ˆå››èˆäº”å…¥ï¼‰+ åƒåˆ†ä½
    function money(n){
      const v = Number(n) || 0;
      return CURRENCY + new Intl.NumberFormat('en-US', {
        maximumFractionDigits: 0,
        minimumFractionDigits: 0
      }).format(v);
    }
    function normPrice(val){ const n = Number(String(val??'').replace(/[^\d.-]/g,'')); return Number.isFinite(n)? n : 0; }
    function showImgModal(src){ document.getElementById('imgModalPic').src = src; document.getElementById('imgModal').classList.add('active'); }

    // è¯†åˆ«â€œçœŸ/å”®ç½„â€çš„å†™æ³•
    function isTrue(v){ return /^(y|yes|true|1|sold(?:\s*out)?|å”®ç½„|ç¼ºè´§)$/i.test(String(v||'').trim()); }

    // é…é€ï¼šdelivery / pickup
    function getShipMethod(){
      return document.querySelector('input[name="ship"]:checked')?.value || 'delivery';
    }
    function onShipChange(){
      const method = getShipMethod();
      const addrInput = document.getElementById('custAddr');
      if(method === 'pickup'){
        addrInput.value = PICKUP_ADDRESS;
        addrInput.disabled = true;
      }else{
        if(addrInput.value === PICKUP_ADDRESS) addrInput.value = "";
        addrInput.disabled = false;
        addrInput.placeholder = "Full address";
      }
      renderOrderSummary();
    }

    // è¿è´¹ï¼ˆå« promo é€»è¾‘ï¼‰
    function getShippingFee(){
      if (getShipMethod() !== 'delivery') return 0; // è‡ªå– 0

      if (!activePromo) return 20; // é»˜è®¤ 20

      const subtotal = cart.reduce((a,b)=>a + b.qty*b.price, 0);
      const pass = subtotal >= (activePromo.min_total || 0);
      if (!pass) return 20;

      if (activePromo.free_ship) return 0; // å…é‚®
      if (activePromo.ship_fee != null) return Number(activePromo.ship_fee) || 0; // æŒ‡å®šé‚®è´¹
      return 20;
    }

    // ======= å¹¿å‘Šå¼¹çª— =======
    window.closeAd = function(){ const m = document.getElementById('adModal'); if(m) m.classList.add('hidden'); };
    (function(){
      fetch(AD_URL).then(r=>r.json()).then(rows=>{
        if(rows && rows.length){
          const r = rows[0]||{}; const enabled = String(r.enabled||'').trim().toLowerCase()==='yes';
          const adImg = (r.img||'').trim();
          if(enabled && adImg){ const m = document.getElementById('adModal'); const img = document.getElementById('adImg'); img.src = adImg; m.classList.remove('hidden'); }
        }
      }).catch(()=>{});
    })();

    // ======= è·‘é©¬ç¯ =======
    (function(){
      fetch(NOTICE_URL).then(r=>r.json()).then(rows=>{
        let notices = rows.map(r=>r.msg).filter(Boolean);
        let mainMsg = notices[0] || "";
        let others = notices.slice(1);
        let now = new Date();
        let mel = new Date(now.toLocaleString("en-US",{timeZone:"Australia/Melbourne"}));
        if(mel.getHours() < 10) mel.setDate(mel.getDate()-1);
        let idx = (mel.getFullYear()*372 + (mel.getMonth()+1)*31 + mel.getDate());
        let oneMsg = others.length? others[idx % others.length] : "";
        const showText = oneMsg? (mainMsg + "   |   " + oneMsg) : mainMsg;
        const marquee = document.getElementById('marqueeText');
        const clone = document.getElementById('marqueeTextClone');
        marquee.innerText = showText; clone.innerText = showText;
        const inner = document.getElementById('marqueeInner'); let speed = 1.2; let pos = 0;
        function scroll(){ const unitWidth = marquee.offsetWidth; pos -= speed; if(Math.abs(pos)>=unitWidth) pos = 0; inner.style.transform=`translateX(${pos}px)`; requestAnimationFrame(scroll); }
        setTimeout(scroll, 350);
      });
    })();

    // ======= Promo è¯»å–ä¸å±•ç¤º =======
    function melKey(d){ return d.getFullYear()*10000 + (d.getMonth()+1)*100 + d.getDate(); }
    function parseKey(s){
      if(!s) return null;
      const m = String(s).trim().match(/^(\d{4})[-/](\d{1,2})[-/](\d{1,2})$/);
      if(!m) return null;
      return (+m[1])*10000 + (+m[2])*100 + (+m[3]);
    }
    function yes(v){ return /^(y|yes|true|1)$/i.test(String(v||'').trim()); }
    async function loadPromo(){
      try{
        const rows = await fetch(PROMO_URL).then(r=>r.json());
        const nowMel = new Date(new Date().toLocaleString("en-US",{timeZone:"Australia/Melbourne"}));
        const today = melKey(nowMel);
        const hit = (rows||[]).find(r=>{
          if(!yes(r.enabled)) return false;
          const s = parseKey(r.start), e = parseKey(r.end||r.start);
          if(!s || !e) return false;
          return today >= s && today <= e;
        });
        if(hit){
          activePromo = {
            name      : (hit.name||'').trim(),
            free_ship : yes(hit.free_ship),
            ship_fee  : (hit.ship_fee!==undefined && hit.ship_fee!=='' ? Number(hit.ship_fee) : null),
            min_total : Number(hit.min_total||0) || 0,
            gift      : (hit.gift||'').trim()
          };
        }else{
          activePromo = null;
        }
        renderPromoBadge();
        renderOrderSummary();
      }catch(e){
        activePromo = null;
        renderPromoBadge();
      }
    }
    function renderPromoBadge(){
      const box = document.getElementById('promoBadge');
      if(!box) return;
      if(!activePromo){
        box.style.display = 'none';
        box.innerHTML = '';
        return;
      }
      const title = activePromo.name || 'Promo Today';
      const cond  = activePromo.min_total>0 ? `æ»¡ ${money(activePromo.min_total)} ç”Ÿæ•ˆ` : 'å·²ç”Ÿæ•ˆ';
      const extra = activePromo.free_ship ? 'å…é‚®' :
                    (activePromo.ship_fee!=null ? `é‚®è´¹ ${money(activePromo.ship_fee)}` :
                    (activePromo.gift ? `ğŸ ${activePromo.gift}` : ''));
      box.style.display = '';
      box.innerHTML = `<div class="promo-chip">${title}${extra?` Â· ${extra}`:''}<small>${cond}</small></div>`;
    }

    // ======= æ¸²æŸ“èœå• =======
    fetch(MENU_URL).then(r=>r.json()).then(rows=>{
      const html = rows.map(obj=>{
        // æ•´ä½“å”®ç½„ï¼ˆæˆ–æŒ‰åº“å­˜ï¼‰
        const itemSoldOut = isTrue(obj.soldout) || (obj.stock !== undefined && Number(obj.stock) <= 0);

        // è§„æ ¼/ä»·æ ¼
        let btns = '';
        for (let i = 1; i <= 3; i++) {
          const spec   = obj['spec' + i];
          const rawP   = obj['price' + i];
          const status = obj['status' + i]; // å¯é€‰ï¼šstatus1/status2/status3
          const specSoldOut = itemSoldOut || isTrue(status);
          if (!spec) continue;

          if (!rawP || specSoldOut) {
            btns += `<button class="menu-spec" disabled>${spec} <span class="menu-price">Sold&nbsp;out</span></button>`;
            continue;
          }
          const price = normPrice(rawP);
          const n = String(obj.name || '').replace(/'/g, "\\'");
          const s = String(spec || '').replace(/'/g, "\\'");
          const im= String(obj.img  || '').replace(/'/g, "\\'");
          btns += `<button class="menu-spec" onclick="addToCart('${n}','${s}',${price},'${im}')">${spec} <span class="menu-price">${money(price)}</span></button>`;
        }
        if (!btns) btns = `<button class="menu-spec" disabled>Sold out</button>`;

        // THC/CBD
        let thccbd = obj.thccbd || '';
        if(!thccbd && (obj.thc || obj.cbd)) thccbd = (obj.thc?obj.thc:'') + (obj.cbd?(' / '+obj.cbd):'');

        return `
          <div class="menu-item">
            ${obj.img ? `<img class="menu-img" src="${obj.img}" loading="lazy" onclick="showImgModal('${obj.img}')"/>` : ""}
            <div class="menu-info">
              <div class="menu-name">
                ${obj.name || ""}
                ${obj.badge ? `<span class="menu-badge">${obj.badge}</span>` : ""}
                ${obj.type ? `<span class="menu-type">${obj.type}</span>` : ""}
              </div>
              <div style="display:flex;align-items:center;gap:9px;margin-bottom:2px;flex-wrap:wrap;">
                ${obj.title ? `<span class="menu-title">${obj.title}</span>` : ""}
                ${thccbd ? `<span class="menu-thccbd">THC/CBD: ${thccbd}</span>` : ""}
              </div>
              ${obj.desc ? `<div class="menu-desc">${obj.desc}</div>` : ""}
              <div class="menu-bottom-prices">${btns}</div>
            </div>
          </div>
        `;
      }).join('');
      document.getElementById('menu').innerHTML = html || `<div style="text-align:center;color:#ccc;margin-top:40px;">No items</div>`;
    }).catch(err=>{
      document.getElementById('menu').innerHTML = "<div style='text-align:center;color:var(--bat-gold);margin-top:36vw;font-size:1.08em;'>Load menu failed, please refresh.</div>";
      console.error(err);
    });

    // ======= è´­ç‰©è½¦ / ç»“ç®— =======
    function addToCart(name, spec, price, img){
      const hit = cart.find(x => x.name === name && x.spec === spec);
      if (hit) hit.qty += 1;
      else cart.push({ name, spec, price, qty: 1, img });

      renderCartBar();
      if (document.getElementById('checkoutBg').classList.contains('active')) renderOrderSummary();
    }
    function renderCartBar(){
      const cnt = cart.reduce((a,b)=>a+b.qty,0);
      const total = cart.reduce((a,b)=>a+b.qty*b.price,0);
      document.getElementById('cartInfo').textContent = `Shopping Cart ${cnt} Item Â· ${money(total)}`;
      document.getElementById('checkoutBtn').disabled = (cnt === 0);
    }
    // ç®€å•è½¬ä¹‰
    function esc(s){
      const map = { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' };
      return String(s ?? '').replace(/[&<>"']/g, m => map[m]);
    }
    // åˆ é™¤æŸè¡Œ
    function removeItem(idx){
      if (idx < 0 || idx >= cart.length) return;
      cart.splice(idx, 1);
      renderCartBar();
      renderOrderSummary();
      if (cart.length === 0) closeCheckout();
    }
    window.removeItem = removeItem;

    // è®¢å•æ‘˜è¦ï¼ˆå« Promo è¿è´¹ä¸èµ å“ï¼‰
    function renderOrderSummary(){
      const box = document.getElementById('orderSummary');
      if (!box) return;

      const rowsHtml = cart.map((it, i) => {
        const sub = it.qty * it.price;
        return `<tr>
          <td>${esc(it.name)}</td>
          <td>${esc(it.spec || '')}</td>
          <td class="ar">Ã—${it.qty}</td>
          <td class="ar">${money(it.price)}</td>
          <td class="ar">${money(sub)}</td>
          <td class="ar">
            <button type="button" class="rm-btn" onclick="removeItem(${i})" title="åˆ é™¤">
              <span class="sr-only">åˆ é™¤</span>ğŸ—‘ï¸
            </button>
          </td>
        </tr>`;
      }).join('');

      const isPickup  = getShipMethod() === 'pickup';
      const subtotal  = cart.reduce((a,b)=> a + b.qty*b.price, 0);
      const shipping  = getShippingFee();
      const grand     = subtotal + shipping;
      const addr      = document.getElementById('custAddr').value.trim();

      const promoApplied = !!activePromo && subtotal >= (activePromo.min_total||0) && !isPickup;
      const shippingLabel = (shipping === 0)
        ? (promoApplied && activePromo && activePromo.free_ship ? 'Free (Promo)' : 'Free')
        : money(shipping);

      box.innerHTML = `
        <div class="os-head">Order Summary</div>
        <table>
          <thead>
            <tr>
              <th>Item</th><th>Spec</th>
              <th class="ar">Qty</th><th class="ar">Price</th><th class="ar">Subtotal</th>
              <th class="ar"> </th>
            </tr>
          </thead>
          <tbody>${rowsHtml || `<tr><td colspan="6" style="text-align:center;color:#aaa;padding:8px 0">Cart is empty</td></tr>`}</tbody>
        </table>
        <div class="os-total" style="flex-direction:column;gap:4px;align-items:flex-end">
          <div>Subtotal: ${money(subtotal)}</div>
          ${isPickup ? '' : `<div>Shipping: ${shippingLabel}</div>`}
          <div style="font-weight:900">Total: ${money(grand)}</div>
        </div>
        <div class="os-meta">
          <div>Method: ${isPickup ? 'Pickup' : 'Delivery'}</div>
          ${isPickup ? '' : `<div>Address: ${esc(addr)}</div>`}
          ${activePromo && subtotal >= (activePromo.min_total||0) && activePromo.gift ? `<div>ğŸ Gift: ${esc(activePromo.gift)}</div>` : ''}
        </div>
      `;
    }
    function openCheckout(){
      if(cart.length===0) return;
      onShipChange();
      renderOrderSummary();
      document.getElementById('checkoutBg').classList.add('active');
      document.body.classList.add('modal-open');
    }
    function closeCheckout(){
      document.getElementById('checkoutBg').classList.remove('active');
      document.body.classList.remove('modal-open');
    }

    // iOS/Safari/TG WebView ç»‘å®šå…¼å®¹
    function openTelegramLink(url, openedWindow){
      const ua = navigator.userAgent || '';
      const inTelegramWebView = /Telegram/i.test(ua);

      if (inTelegramWebView) { location.href = url; return; }
      if (openedWindow) openedWindow.location.href = url;
      else {
        const a = document.createElement('a');
        a.href = url; a.target = '_blank'; a.rel = 'noopener';
        document.body.appendChild(a); a.click(); a.remove();
      }
      setTimeout(()=>{
        if (document.visibilityState === 'visible') {
          alert('å¦‚æœæ²¡æœ‰è‡ªåŠ¨æ‰“å¼€ Telegramï¼Œè¯·ç‚¹å‡»ç¡®è®¤åå†æ¬¡å°è¯•ï¼Œæˆ–å¤åˆ¶é“¾æ¥åˆ° Safari æ‰“å¼€ï¼š\n' + url);
        }
      }, 800);
    }

    async function submitOrder(){
      const msg = document.getElementById('checkoutMsg');
      const name = document.getElementById('custName').value.trim();
      const phone= document.getElementById('custPhone').value.trim();
      const addr = document.getElementById('custAddr').value.trim();
      const notes= document.getElementById('custNotes').value.trim();
      const ship = getShipMethod();

      msg.className='checkout-msg'; msg.textContent='';
      if(!cart.length){ msg.className='checkout-msg err'; msg.textContent='Cart is empty'; return; }
      if(!name || !phone || !addr){ msg.className='checkout-msg err'; msg.textContent='Please fill in your name / phone number / address'; return; }
      if(cart.some(x => !x.price || x.price <= 0)){ msg.className='checkout-msg err'; msg.textContent='Some product prices are invalid, please refresh and try again'; return; }

      const payload = {
        items: cart.map(x=>({name:x.name,spec:x.spec,price:x.price,qty:x.qty})),
        name, phone, address: addr, notes,
        delivery: ship
      };

      // å¼ºåˆ¶ç»‘å®šï¼ˆæäº¤æ—¶æ‹¦æˆªï¼‰
      const tgChatId = localStorage.getItem('tg_chat_id');
      if (!tgChatId) {
        msg.className = 'checkout-msg err';
        msg.innerHTML = 'Please bind Telegram before placing an order ' +
                        '<a href="#" onclick="bindTelegram();return false;">Bind Now</a>';
        return;
      }
      payload.tg_chat_id = tgChatId;

      try{
        const res = await fetch(`${API_BASE}/order`, {
          method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
        });
        const data = await res.json();
        if(res.ok){
          msg.className='checkout-msg ok';
          if (data.user_notified){
            msg.textContent = 'Order successful! You have been notified via Telegram.';
          } else if (data.tg_deeplink){
            msg.innerHTML = 'Order placed! Click here to receive this order in Telegram ğŸ‘‰ ' + `<a href="${data.tg_deeplink}" target="_blank" rel="noopener">Enable notifications</a>`;
          } else {
            msg.textContent = 'Order Successfullyï¼';
          }
          cart.splice(0, cart.length); renderCartBar();
          document.getElementById('custName').value =
          document.getElementById('custPhone').value =
          document.getElementById('custAddr').value =
          document.getElementById('custNotes').value = '';
          setTimeout(closeCheckout, 1200);
        }else{
          msg.className='checkout-msg err';
          msg.textContent = data.error || 'Failed, please try again later';
        }
      }catch(e){
        msg.className='checkout-msg err';
        msg.textContent='Network Error, please try again later';
      }
    }

    // ä¸€é”®ç»‘å®šï¼ˆiOS ä¿®å¤ï¼‰
    async function bindTelegram(){
      if (window._bindingRunning) return;
      window._bindingRunning = true;
      let w = null;
      try{
        w = window.open('', '_blank'); // å…ˆæ‰“å¼€ç©ºç™½é¡µï¼ˆé¿å… iOS æ‹¦æˆªï¼‰
        const r = await fetch(`${API_BASE}/bind/new`, {method:'POST'});
        const data = await r.json();
        if(!r.ok || !data.tg_deeplink){
          if (w) w.close();
          alert(data.error || 'Binding failed, please try again later');
          return;
        }
        openTelegramLink(data.tg_deeplink, w);

        const code = data.code;
        const start = Date.now();
        const timer = setInterval(async ()=>{
          const rr = await fetch(`${API_BASE}/bind/status?code=${encodeURIComponent(code)}`);
          const s = await rr.json();
          if(s.status==='ok'){
            clearInterval(timer);
            localStorage.setItem('tg_chat_id', s.chat_id);
            alert('âœ… ç»‘å®šæˆåŠŸï¼');
            renderCartBar();
          }else if(Date.now()-start>120000){
            clearInterval(timer);
          }
        }, 2000);
      }catch(e){
        if (w) w.close();
        alert('Binding failed, please try again later');
      }finally{
        window._bindingRunning = false;
      }
    }

    // äº‹ä»¶ç»‘å®š & åˆå§‹åŒ–
    document.querySelectorAll('input[name="ship"]').forEach(el=>{
      el.addEventListener('change', onShipChange);
    });
    onShipChange();
    renderCartBar();
    loadPromo(); // è¯»å–æ´»åŠ¨
  </script>
</body>
</html>
