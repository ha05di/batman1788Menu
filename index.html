<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Batman1788 Menu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Optional: Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-5DBPBMP3K1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-5DBPBMP3K1');
  </script>

  <style>
    :root{
      --bat-black:#18191b;
      --bat-card:rgba(35,36,39,.90);
      --bat-gold:#ffe02e;
      --accent:#ffe02e;
      --err:#ff5555;
      --ok:#4cd964;
    }

    *{ box-sizing:border-box; }
    body{ margin:0; background:var(--bat-black); color:#fff; font-family:'Segoe UI','PingFang SC','Microsoft YaHei',Arial,sans-serif; }
    a{ color:var(--bat-gold); }

    .header{
      padding:14px 0 7px; text-align:center; font-size:1.25em; font-weight:800; letter-spacing:2px;
      background:var(--bat-black); color:var(--bat-gold);
      text-shadow:0 2px 24px #000, 0 1px 0 #fff3; border-bottom:1.5px solid #2c2c2e;
      position:sticky; top:0; z-index:9;
    }

    .marquee-wrap{ background:#2a2927; border-bottom:1.2px solid #282828; overflow:hidden; position:sticky; top:0; z-index:22; height:38px; }
    .marquee-text{ color:var(--bat-gold); font-size:1.03em; font-weight:600; line-height:38px; white-space:nowrap; will-change:transform; text-shadow:0 1px 10px #0006; }

    .menu-wrap{ max-width:530px; margin:0 auto; padding:18px 0 120px; }

    .menu-item{
      display:flex; background:var(--bat-card); border-radius:18px; margin:0 12px 18px; padding:13px 12px 18px;
      border:1.2px solid var(--bat-gold); box-shadow:0 3px 14px #ffe02e1b, 0 0 0 1.6px #ffe02e33; transition:.15s; position:relative; overflow:hidden;
    }
    .menu-item::before{
      content:""; position:absolute; inset:0;
      background:url('https://raw.githubusercontent.com/ha05di/batman1788shop/main/logo.png') center/85% no-repeat;
      opacity:.23; pointer-events:none;
    }
    .menu-item>*{ position:relative; z-index:1; }
    .menu-img{
      width:68px; height:68px; border-radius:13px; object-fit:cover; background:#252323; margin-right:13px;
      border:1.3px solid var(--bat-gold); box-shadow:0 2px 10px #ffe02e3a; cursor:pointer; transition:box-shadow .18s; flex-shrink:0;
    }
    .menu-img:hover{ box-shadow:0 4px 20px #ffe02ea0; }
    .menu-info{ flex:1; min-width:0; display:flex; flex-direction:column; }
    .menu-name{ font-size:1.15em; font-weight:700; margin-bottom:2.5px; color:var(--bat-gold); display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
    .menu-badge{ background:linear-gradient(90deg,#ffe02e,#ffc400); color:#111; border-radius:9px; font-size:.83em; font-weight:600; padding:2px 9px; box-shadow:0 1px 5px #ffe02e44; }
    .menu-type{ background:#303030; color:var(--bat-gold); font-size:.8em; border-radius:7px; padding:2px 8px; border:1px solid #ffe02e2c; }
    .menu-title{ color:var(--bat-gold); font-size:.95em; margin-right:4px; }
    .menu-thccbd{ color:#ffe02e; font-size:.97em; font-weight:500; }
    .menu-desc{ font-size:.97em; color:#f8f6c7; margin-top:7px; line-height:1.48; text-shadow:0 1px 4px #1a17084f; }
    .menu-bottom-prices{ display:flex; gap:10px; flex-wrap:wrap; margin-top:14px; }
    .menu-spec{ background:#2d2c22; color:var(--bat-gold); font-size:1.01em; border-radius:7px; padding:6px 12px; border:1.1px solid var(--bat-gold); box-shadow:0 1px 6px #ffe02e22; font-weight:900; cursor:pointer; }
    .menu-price{ color:#ffe02e; font-weight:900; font-size:1.02em; margin-left:3px; }

    .menu-spec[disabled]{ opacity:.55; cursor:not-allowed; filter:grayscale(0.3); border-color:#666; box-shadow:none; }

    .cart-bar{
      position:fixed; left:0; right:0; bottom:0; z-index:50; background:#101114; border-top:1px solid #2c2c2e; padding:10px 14px;
      display:flex; align-items:center; justify-content:center; gap:10px;
    }
    .cart-info{ color:#fff; font-weight:700; }
    .cart-btn{ background:var(--accent); color:#111; border:none; padding:10px 16px; border-radius:10px; font-weight:900; cursor:pointer; }
    .cart-btn:disabled{ opacity:.5; cursor:not-allowed; }

    .checkout-bg{
      position:fixed; inset:0; padding:10px;
      background:rgba(0,0,0,.72); display:none; align-items:center; justify-content:center; z-index:99;
    }
    .checkout-bg.active{ display:flex; }
    .checkout{
      width:min(560px, 92vw);
      max-height:calc(100vh - 40px);
      overflow-y:auto; overflow-x:hidden; -webkit-overflow-scrolling:touch;
      background:#1f2024; border:1px solid #444; border-radius:16px; padding:16px; box-shadow:0 4px 30px #000a;
    }
    .checkout *{ min-width:0; }
    .checkout h3{ margin:4px 0 12px; color:var(--bat-gold); }

    .f{ display:flex; gap:10px; margin-bottom:10px; flex-wrap:wrap; }
    .f .i{ flex:1; }
    .i label{ display:block; font-size:.92em; color:#ddd; margin-bottom:6px; }
    .i input,.i textarea{ width:100%; background:#121316; color:#fff; border:1px solid #3a3a3a; border-radius:10px; padding:10px 12px; outline:none; }

    .checkout-actions{ display:flex; gap:10px; margin-top:10px; }
    .btn{ background:#2b2c30; color:#fff; border:1px solid #444; padding:10px 14px; border-radius:10px; cursor:pointer; }
    .btn.primary{ background:var(--accent); color:#111; border:none; font-weight:900; }
    .checkout-msg{ margin-top:8px; font-size:.95em; }
    .checkout-msg.ok{ color:var(--ok); }
    .checkout-msg.err{ color:var(--err); }

    /* ========= Order Summary (桌面 + 手机) ========= */
    .order-summary{
      background:#141519;
      border:1px solid #2f2f33;
      border-radius:12px;
      padding:10px 12px;
      margin:10px 0;
    }
    .order-summary .os-head{
      font-weight:800;
      color:#ffe02e;
      margin-bottom:6px;
    }

    /* ---- 桌面端：标准表格 ---- */
    .order-summary table{
      width:100%;
      border-collapse:collapse;
      font-size:.95em;
      table-layout:fixed;
    }
    .order-summary th,
    .order-summary td{
      padding:6px 8px;
      border-bottom:1px dashed #2a2a2a;
      word-break:normal;
      overflow-wrap:normal;
    }
    .order-summary th{
      color:#ddd;
      font-weight:700;
      text-align:left;
      white-space:nowrap;     /* 表头不拆行 */
    }
    .order-summary .ar{ text-align:right; }

    /* 列宽与对齐（桌面端） */
    .order-summary th:nth-child(1), .order-summary td:nth-child(1){ width:40%; }         /* Item */
    .order-summary th:nth-child(2), .order-summary td:nth-child(2){ width:10%; text-align:center; }  /* Spec */
    .order-summary th:nth-child(3), .order-summary td:nth-child(3){ width:10%; text-align:center; }  /* Qty  */
    .order-summary th:nth-child(4), .order-summary td:nth-child(4){ width:20%; text-align:right; }   /* Price */
    .order-summary th:nth-child(5), .order-summary td:nth-child(5){ width:20%; text-align:right; }   /* Subtotal */
    .order-summary th:nth-child(6), .order-summary td:nth-child(6){ width:36px;  text-align:right; } /* 删除 */

    .order-summary .item-cell{
      display:block;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;        /* 超长省略号 */
    }

    .order-summary .os-total{
      display:flex;
      justify-content:flex-end;
      font-weight:900;
      margin-top:6px;
    }
    .order-summary .os-meta{
      color:#bbb;
      font-size:.92em;
      margin-top:6px;
      line-height:1.4;
    }

    /* 删除按钮 */
    .order-summary .rm-btn{
      background:#3a3b40; color:#fff; border:1px solid #555;
      width:32px; height:28px; border-radius:8px; cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center;
      font-size:16px; line-height:1;
    }
    .order-summary .rm-btn:hover{ background:#ff5555; border-color:#ff5555; }
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }

    /* ---- 手机端 ≤640px：商品名一行；下一行把 Spec / Qty / Price 并排；Subtotal 单独一行 ---- */
    @media (max-width:640px){
      /* 隐藏表头，改为“卡片式”一行一项 */
      .order-summary table{ table-layout:auto !important; }
      .order-summary table thead{ display:none !important; }

      .order-summary table tbody tr{
        display:block !important;
        position:relative !important;
        padding:10px 0 8px;
        border-bottom:1px dashed #2a2a2a;
      }
      .order-summary table tbody td{
        display:block !important;
        border-bottom:0 !important;
        padding:6px 2px !important;
        word-break:normal !important;      /* 不把数字/符号硬拆 */
        overflow-wrap:normal !important;
        white-space:normal !important;
      }

      /* 1) 商品名（第一格） */
      .order-summary table tbody td:nth-child(1){
        font-weight:800; color:var(--bat-gold);
        white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
        padding-right:44px;                 /* 右上角给删除按钮让位 */
      }

      /* 2) 把 Spec / Qty / Price 并排到同一排 */
      .order-summary table tbody td:nth-child(2),
      .order-summary table tbody td:nth-child(3),
      .order-summary table tbody td:nth-child(4){
        display:inline-flex !important;
        align-items:center; gap:6px;
        margin-right:14px; padding:2px 0 !important;
        white-space:nowrap !important;     /* ×1 / $130 不会断开 */
        font-variant-numeric:tabular-nums;
      }
      .order-summary table tbody td:nth-child(2)::before{ content:"Spec";  color:#bbb; margin-right:6px; }
      .order-summary table tbody td:nth-child(3)::before{ content:"Qty";   color:#bbb; margin-right:6px; }
      .order-summary table tbody td:nth-child(4)::before{ content:"Price"; color:#bbb; margin-right:6px; }

      /* 3) Subtotal 另起一行，左右对齐 */
      .order-summary table tbody td:nth-child(5){
        display:flex !important; justify-content:space-between;
        padding-top:6px !important; white-space:nowrap !important;
        font-variant-numeric:tabular-nums;
      }
      .order-summary table tbody td:nth-child(5)::before{
        content:"Subtotal"; color:#bbb; margin-right:8px;
      }

      /* 4) 删除按钮固定到行右上角 */
      .order-summary table tbody td:nth-child(6){
        position:absolute !important;
        right:0; top:6px;
        display:block !important; padding:0 !important; width:auto !important;
        text-align:right;
      }
    }

    /* 超窄屏（可选）：隐藏“Price”标签，只保留金额；让三块更容易同排 */
    @media (max-width:360px){
      .order-summary table tbody td:nth-child(4)::before{ content:""; margin:0; }
    }
    /* 手机端：一排整齐 + 去掉小计 + 商品名全显示 */
    @media (max-width:640px){
      /* 商品名：允许换行、显示完整；右侧给删除按钮留空 */
      .order-summary table tbody td:nth-child(1){
        white-space: normal !important;
        overflow: visible !important;
        text-overflow: clip !important;
        padding-right: 44px;           /* 避免与垃圾桶重叠 */
        margin-bottom: 2px;
      }

      /* Spec / Qty / Price 摆到同一排并统一对齐 */
      .order-summary table tbody td:nth-child(2),
      .order-summary table tbody td:nth-child(3),
      .order-summary table tbody td:nth-child(4){
        display: inline-flex !important;
        align-items: baseline;
        gap: 6px;                      /* 标签与值 */
        margin-right: 0;               /* 由分隔符控制间距 */
        padding: 2px 0 !important;
        white-space: nowrap !important;/* 不换行（×1/$120 不拆） */
        font-size: .96em;
        line-height: 1.25;
        font-variant-numeric: tabular-nums;
      }
      /* 分隔点让三块更整齐 */
      .order-summary table tbody td:nth-child(2)::after,
      .order-summary table tbody td:nth-child(3)::after{
        content: "·";
        color: #666;
        margin: 0 10px;
      }

      /* 去掉每一项的小计行（Subtotal） */
      .order-summary table tbody td:nth-child(5){
        display: none !important;
      }
    }


    .radio-group label{ margin-right:12px; cursor:pointer; }
    .radio-group input{ vertical-align:middle; margin-right:6px; }
    .radio-group{
      display:flex;
      align-items:center;
      gap:18px;                 /* 两个选项之间的距离 */
      padding:6px 8px;
      background:#15161a;
      border:1px solid #2a2a2e;
      border-radius:10px;
      width:max-content;        /* 只包内容，不撑满整行 */
    }
    .radio-group label{
      display:inline-flex;      /* 让文字与圆点同一基线 */
      align-items:center;
      gap:8px;                  /* 圆点与文字的距离 */
      margin:0;                 /* 清掉默认外边距，避免“断层线”错觉 */
      font-weight:600;
      line-height:1;            /* 避免高度不齐 */
    }
    .radio-group input[type="radio"]{
      margin:0;                 /* 让圆点垂直居中 */
      accent-color: var(--bat-gold); /* 选中颜色与主题一致 */
      transform: translateY(0.5px);  /* 细微校正 */
    }

    /* 小屏幕可以更紧凑一些 */
    @media (max-width:480px){
      .radio-group{ gap:12px; padding:5px 6px; }
      .radio-group label{ gap:6px; }
    }

    .img-modal-bg{ position:fixed; inset:0; background:rgba(0,0,0,.75); display:none; justify-content:center; align-items:center; z-index:9999; }
    .img-modal-bg.active{ display:flex; }
    .img-modal-bg img{ max-width:90vw; max-height:84vh; border-radius:16px; box-shadow:0 2px 28px #000a; background:#111; }

    .contact-fab{
      position:fixed; right:21px; bottom:70px; z-index:60; background:#ffe02e; border-radius:50%;
      box-shadow:0 3px 18px #0006; width:52px; height:52px; display:flex; align-items:center; justify-content:center; border:none; cursor:pointer;
    }
    .contact-fab:hover{ box-shadow:0 7px 28px #ffe02e55; transform:scale(1.05); }

    .footer{ position:fixed; left:0; bottom:0; width:100vw; color:#ffc400; background:#18191b; font-size:.98em; text-align:center; padding:12px 0 9px; z-index:22; border-top:1.5px solid #2c2c2e; }

    body.modal-open{ overflow:hidden; }

    @media (max-width:700px){
      .menu-wrap{ padding:5px 0 130px; }
      .menu-item{ margin:0 3vw 15px; padding:10px 5px 18px; }
      .menu-img{ width:54px; height:54px; margin-right:7px; }
      .menu-name{ font-size:1.05em; }
    }
    @media (max-width:480px){
      .contact-fab{ right:12px; bottom:72px; width:44px; height:44px; }
      .contact-fab svg{ width:22px; height:22px; }
    }
  </style>
</head>
<body>
  <div class="header">Batman1788 Menu</div>

  <div class="marquee-wrap">
    <div id="marqueeInner" style="white-space:nowrap;display:flex;">
      <span class="marquee-text" id="marqueeText"></span>
      <span class="marquee-text" id="marqueeTextClone"></span>
    </div>
  </div>

  <!-- Bind Telegram -->
  <div style="max-width:530px;margin:10px auto 0; padding:0 12px; text-align:center;">
    <button type="button" class="menu-spec" onclick="bindTelegram()">One-click binding Telegram</button>
  </div>

  <div class="menu-wrap" id="menu"></div>

  <!-- Cart bar -->
  <div class="cart-bar">
    <div class="cart-info" id="cartInfo">Shopping Cart 0 Item · $0.00</div>
    <button class="cart-btn" id="checkoutBtn" onclick="openCheckout()" disabled>Check Out</button>
  </div>

  <!-- Checkout modal -->
  <div class="checkout-bg" id="checkoutBg">
    <div class="checkout">
      <h3>Fill in the information</h3>

      <div class="f"><div class="i">
        <label>Name</label><input id="custName" placeholder="Recipient's name" />
      </div></div>

      <!-- Delivery method -->
      <div class="f"><div class="i">
        <label>Delivery method</label>
        <div class="radio-group">
          <label><input type="radio" name="ship" value="delivery" checked> Delivery</label>
          <label><input type="radio" name="ship" value="pickup"> Pickup</label>
        </div>
      </div></div>

      <div class="f">
        <div class="i"><label>Phone No.</label><input id="custPhone" placeholder="+61 ..." /></div>
        <div class="i"><label>Address</label><input id="custAddr" placeholder="Full address" /></div>
      </div>

      <div class="f"><div class="i">
        <label>Notes (optional)</label><textarea id="custNotes" rows="3" placeholder="Example: Drop-off time / door note"></textarea>
      </div></div>

      <!-- PROMO 输入区 -->
      <div class="f"><div class="i">
        <label>Promo Code</label>
        <div style="display:flex;gap:8px;align-items:center;">
          <input id="promoCodeInput" placeholder="Enter promo code" />
          <button class="btn" type="button" onclick="applyPromoCode()">Apply</button>
          <button class="btn" type="button" onclick="clearPromoCode()">Clear</button>
        </div>
        <div id="promoMsg" class="checkout-msg"></div>
      </div></div>

      <div id="orderSummary" class="order-summary"></div>

      <div class="checkout-actions">
        <button class="btn" onclick="closeCheckout()">Cancel</button>
        <button class="btn primary" onclick="submitOrder()">Submit Order</button>
      </div>
      <div class="checkout-msg" id="checkoutMsg"></div>
    </div>
  </div>

  <!-- Floating contact -->
  <a href="https://t.me/batman1788" target="_blank" class="contact-fab" title="Customer Service">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="#fff" style="vertical-align:middle">
      <circle cx="12" cy="12" r="12" fill="#ffe02e" />
      <path d="M17 10.5c0-.83-.67-1.5-1.5-1.5h-7C7.67 9 7 9.67 7 10.5v3c0 .83.67 1.5 1.5 1.5H9v2l3-2h3.5c.83 0 1.5-.67 1.5-1.5v-3z" fill="#18191b"/>
    </svg>
  </a>

  <!-- Image modal -->
  <div class="img-modal-bg" id="imgModal" onclick="this.classList.remove('active')">
    <img id="imgModalPic" src="" />
  </div>

  <div class="footer">
    Batman1788 © Menu |
    <a href="https://t.me/batman1788" target="_blank">Telegram Order</a>
  </div>

  <!-- Ad modal -->
  <div class="ad-modal-bg hidden" id="adModal">
    <div class="ad-modal">
      <img id="adImg" src="" alt="Promo" />
      <button class="ad-close" type="button" onclick="window.closeAd()">×</button>
    </div>
  </div>
  <style>
    .ad-modal-bg{ position:fixed; inset:0; background:rgba(0,0,0,.78); display:flex; align-items:center; justify-content:center; z-index:10000; }
    .hidden{ display:none!important; }
    .ad-modal{ position:relative; max-width:90vw; max-height:80vh; border-radius:16px; overflow:hidden; box-shadow:0 4px 25px #000a; background:#111; }
    .ad-modal img{ width:100%; height:auto; display:block; }
    .ad-close{ position:absolute; top:6px; right:6px; background:rgba(0,0,0,.6); color:#fff; border:none; border-radius:50%; width:32px; height:32px; font-size:20px; font-weight:bold; cursor:pointer; line-height:30px; }
    .ad-close:hover{ background:rgba(0,0,0,.85); }
  </style>

  <script>
    // ======= Config =======
    const API_BASE = ""; // same origin
    const SHEET_ID = "1hUlRnvEy-k2Arz8SVKpRsAaBEFTyS6RDJBDfwDmM-Hs";
    const SHEET_TAB_MENU   = "batmenu";
    const SHEET_TAB_NOTICE = "notice";
    const MENU_URL   = `https://opensheet.elk.sh/${SHEET_ID}/${SHEET_TAB_MENU}`;
    const NOTICE_URL = `https://opensheet.elk.sh/${SHEET_ID}/${SHEET_TAB_NOTICE}`;
    const AD_URL     = `https://opensheet.elk.sh/${SHEET_ID}/ad`;

    /* PROMO 规则（来自 promo sheet）
       列：enabled | type | value | min_subtotal | code | auto | stack | desc | start | end */
    const PROMO_URL  = `https://opensheet.elk.sh/${SHEET_ID}/promo`;

    const PICKUP_ADDRESS = "1 Kingston St, Malvern East VIC 3145, Australia"; // ★ 自取默认地址

    // ======= Utils & State =======
    const cart = [];
    const CURRENCY = "$";

    function money(n){
      const v = Number(n) || 0;
      return CURRENCY + new Intl.NumberFormat('en-US', {
        maximumFractionDigits: 0,
        minimumFractionDigits: 0
      }).format(v);
    }
    function normPrice(val){ const n = Number(String(val??'').replace(/[^\d.-]/g,'')); return Number.isFinite(n)? n : 0; }
    function showImgModal(src){ document.getElementById('imgModalPic').src = src; document.getElementById('imgModal').classList.add('active'); }

    function getShippingFee(){
      return getShipMethod() === 'delivery' ? 20 : 0;
    }
    function isTrue(v){
      return /^(?:y|yes|true|1|sold(?:\s*out)?|售罄|缺货)$/i.test(String(v||'').trim());
    }
    function isYes(v){ return /^(?:y|yes|true|1)$/i.test(String(v||'').trim()); }

    // ★ Melbourne 当天 YYYY-MM-DD
    function ymdMel(){
      const d = new Date(new Date().toLocaleString("en-US",{timeZone:"Australia/Melbourne"}));
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${d.getFullYear()}-${mm}-${dd}`;
    }
    // ★ 判断 promo 是否在 start/end 有效期内（没填日期则一直有效）
    function isActiveNow(p){
      if(!p.start && !p.end) return true;
      const today = ymdMel();
      const s = p.start || '0000-01-01';
      const e = p.end   || '9999-12-31';
      return s <= today && today <= e;
    }

    function getShipMethod(){
      return document.querySelector('input[name="ship"]:checked')?.value || 'delivery';
    }
    function onShipChange(){
      const method = getShipMethod();
      const addrInput = document.getElementById('custAddr');
      if(method === 'pickup'){
        addrInput.value = PICKUP_ADDRESS;
        addrInput.disabled = true;
      }else{
        if(addrInput.value === PICKUP_ADDRESS) addrInput.value = "";
        addrInput.disabled = false;
        addrInput.placeholder = "Full address";
      }
      renderOrderSummary();
    }

    // ======= Ad modal =======
    window.closeAd = function(){ const m = document.getElementById('adModal'); if(m) m.classList.add('hidden'); };
    (function(){
      fetch(AD_URL).then(r=>r.json()).then(rows=>{
        if(rows && rows.length){
          const r = rows[0]||{}; const enabled = String(r.enabled||'').trim().toLowerCase()==='yes';
          const adImg = (r.img||'').trim();
          if(enabled && adImg){ const m = document.getElementById('adModal'); const img = document.getElementById('adImg'); img.src = adImg; m.classList.remove('hidden'); }
        }
      }).catch(()=>{});
    })();

    // ======= Marquee =======
    (function(){
      fetch(NOTICE_URL).then(r=>r.json()).then(rows=>{
        let notices = rows.map(r=>r.msg).filter(Boolean);
        let mainMsg = notices[0] || "";
        let others = notices.slice(1);
        let now = new Date();
        let mel = new Date(now.toLocaleString("en-US",{timeZone:"Australia/Melbourne"}));
        if(mel.getHours() < 10) mel.setDate(mel.getDate()-1);
        let idx = (mel.getFullYear()*372 + (mel.getMonth()+1)*31 + mel.getDate());
        let oneMsg = others.length? others[idx % others.length] : "";
        const showText = oneMsg? (mainMsg + "   |   " + oneMsg) : mainMsg;
        const marquee = document.getElementById('marqueeText');
        const clone = document.getElementById('marqueeTextClone');
        marquee.innerText = showText; clone.innerText = showText;
        const inner = document.getElementById('marqueeInner'); let speed = 1.2; let pos = 0;
        function scroll(){ const unitWidth = marquee.offsetWidth; pos -= speed; if(Math.abs(pos)>=unitWidth) pos = 0; inner.style.transform=`translateX(${pos}px)`; requestAnimationFrame(scroll); }
        setTimeout(scroll, 350);
      });
    })();

    // ======= PROMO rules (load once) =======
    let PROMO_RULES = [];
    let MANUAL_PROMO = null;   // {code,type,value,min,stack,desc,start,end}
    function normalizePromoRow(r){
      return {
        enabled: isYes(r.enabled),
        type: String(r.type||'').trim().toLowerCase(),   // freeship | minus | percent | info | gift
        value: Number(r.value || 0) || 0,
        min: Number(r.min_subtotal || r.min || 0) || 0,
        code: String(r.code||'').trim().toUpperCase(),
        auto: isYes(r.auto),
        stack: isYes(r.stack),
        desc: String(r.desc||r.note||'').trim(),
        start: String(r.start||'').trim(),   // YYYY-MM-DD
        end:   String(r.end||'').trim()      // YYYY-MM-DD
      };
    }
    function loadPromos(){
      return fetch(PROMO_URL).then(r=>r.json()).then(rows=>{
        PROMO_RULES = (rows||[]).map(normalizePromoRow).filter(p=>p.enabled && isActiveNow(p));
      }).catch(()=>{ PROMO_RULES = []; });
    }

    // ======= Render menu =======
    fetch(MENU_URL).then(r=>r.json()).then(rows=>{
      const html = rows.map(obj=>{
        let btns = '';
        const itemSoldOut = isTrue(obj.soldout) || (obj.stock !== undefined && Number(obj.stock) <= 0);

        for (let i = 1; i <= 3; i++) {
          const spec = obj['spec' + i];
          const rawP = obj['price' + i];
          const status = obj['status' + i];
          const specSoldOut = itemSoldOut || isTrue(status);

          if (!spec) continue;

          if (!rawP || specSoldOut) {
            btns += `<button class="menu-spec" disabled>${spec} <span class="menu-price">Sold&nbsp;out</span></button>`;
            continue;
          }

          const price = normPrice(rawP);
          const n = String(obj.name || '').replace(/'/g, "\\'");
          const s = String(spec).replace(/'/g, "\\'");
          const im = String(obj.img || '').replace(/'/g, "\\'");
          btns += `<button class="menu-spec" onclick="addToCart('${n}','${s}',${price},'${im}')">${spec} <span class="menu-price">${money(price)}</span></button>`;
        }

        if (!btns) btns = `<button class="menu-spec" disabled>Sold out</button>`;

        let thccbd = obj.thccbd || '';
        if(!thccbd && (obj.thc || obj.cbd)) thccbd = (obj.thc?obj.thc:'') + (obj.cbd?(' / '+obj.cbd):'');

        return `
          <div class="menu-item">
            ${obj.img ? `<img class="menu-img" src="${obj.img}" loading="lazy" onclick="showImgModal('${obj.img}')"/>` : ""}
            <div class="menu-info">
              <div class="menu-name">
                ${obj.name || ""}
                ${obj.badge ? `<span class="menu-badge">${obj.badge}</span>` : ""}
                ${obj.type ? `<span class="menu-type">${obj.type}</span>` : ""}
              </div>
              <div style="display:flex;align-items:center;gap:9px;margin-bottom:2px;flex-wrap:wrap;">
                ${obj.title ? `<span class="menu-title">${obj.title}</span>` : ""}
                ${thccbd ? `<span class="menu-thccbd">THC/CBD: ${thccbd}</span>` : ""}
              </div>
              ${obj.desc ? `<div class="menu-desc">${obj.desc}</div>` : ""}
              <div class="menu-bottom-prices">${btns || '<span style="color:#ccc">No price</span>'}</div>
            </div>
          </div>
        `;
      }).join('');
      document.getElementById('menu').innerHTML = html || `<div style="text-align:center;color:#ccc;margin-top:40px;">No items</div>`;
    }).catch(err=>{
      document.getElementById('menu').innerHTML = "<div style='text-align:center;color:var(--bat-gold);margin-top:36vw;font-size:1.08em;'>Load menu failed, please refresh.</div>";
      console.error(err);
    });

    // ======= Cart / checkout =======
    function addToCart(name, spec, price, img){
      const hit = cart.find(x => x.name === name && x.spec === spec);
      if (hit) hit.qty += 1;
      else cart.push({ name, spec, price, qty: 1, img });
      renderCartBar();
      if (document.getElementById('checkoutBg').classList.contains('active')) renderOrderSummary();
    }
    function renderCartBar(){
      const cnt = cart.reduce((a,b)=>a+b.qty,0);
      const total = cart.reduce((a,b)=>a+b.qty*b.price,0);
      document.getElementById('cartInfo').textContent = `Shopping Cart ${cnt} Item · ${money(total)}`;
      document.getElementById('checkoutBtn').disabled = (cnt === 0);
    }
    function esc(s){
      const map = { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' };
      return String(s ?? '').replace(/[&<>"']/g, m => map[m]);
    }
    function removeItem(idx){
      if (idx < 0 || idx >= cart.length) return;
      cart.splice(idx, 1);
      renderCartBar();
      renderOrderSummary();
      if (cart.length === 0) closeCheckout();
    }
    window.removeItem = removeItem;

    // ======= Promo engine =======
    function getApplicablePromos(subtotal){
      const autos = PROMO_RULES.filter(p=>p.auto && subtotal >= p.min);
      const manualOk = (MANUAL_PROMO && subtotal >= MANUAL_PROMO.min) ? [MANUAL_PROMO] : [];
      return [...autos, ...manualOk];
    }
    function calcPromo(subtotal, baseShipping){
      const promos = getApplicablePromos(subtotal);
      let freeship = false;
      let discount = 0;
      let lines = [];

      promos.forEach(p=>{
        if(p.type === 'freeship'){
          freeship = true;
          lines.push(p.desc || 'Free shipping');
        }else if(p.type === 'minus' && p.value > 0){
          discount += p.value;
          lines.push(p.desc || (`-$${p.value} off`));
        }else if(p.type === 'percent' && p.value > 0){
          const d = subtotal * (p.value/100);
          discount += d;
          lines.push(p.desc || (`${p.value}% off`));
        }else if (p.type === 'info' || p.type === 'gift' || ((p.type==='percent'||p.type==='minus') && p.value<=0)) {
          // 只展示文案，不改价
          if (p.desc) lines.push(p.desc);
        }
      });

      discount = Math.min(discount, subtotal);

      let shipping = baseShipping;
      if (freeship && getShipMethod()==='delivery') shipping = 0;

      const afterDiscount = Math.max(0, subtotal - discount);
      const grand = afterDiscount + shipping;

      return {promos, freeship, discount, shipping, afterDiscount, grand, lines};
    }

    // ======= Promo UI actions =======
    async function applyPromoCode(){
      const inp = document.getElementById('promoCodeInput');
      const msg = document.getElementById('promoMsg');
      const code = String(inp.value||'').trim().toUpperCase();
      msg.className = 'checkout-msg';

      if(!code){
        msg.className = 'checkout-msg err';
        msg.textContent = 'Please enter a promo code';
        return;
      }

      if(!PROMO_RULES.length){
        await loadPromos().catch(()=>{});
      }

      const rule = PROMO_RULES.find(p=>!p.auto && p.code === code);
      if(!rule){
        MANUAL_PROMO = null;
        msg.className = 'checkout-msg err';
        msg.textContent = 'Invalid promo code';
        renderOrderSummary();
        return;
      }
      MANUAL_PROMO = rule;
      msg.className = 'checkout-msg ok';
      msg.textContent = rule.desc ? `Applied: ${rule.desc}` : 'Promo applied';
      renderOrderSummary();
    }
    function clearPromoCode(){
      MANUAL_PROMO = null;
      const msg = document.getElementById('promoMsg');
      msg.className = 'checkout-msg';
      msg.textContent = '';
      renderOrderSummary();
    }
    window.applyPromoCode = applyPromoCode;
    window.clearPromoCode = clearPromoCode;

    // ======= 渲染订单摘要 =======
    function renderOrderSummary(){
      const box = document.getElementById('orderSummary');
      if (!box) return;

      const rowsHtml = cart.map((it, i) => {
        const sub = it.qty * it.price;
        return `<tr>
          <td><span class="item-cell" title="${esc(it.name)}">${esc(it.name)}</span></td>
          <td>${esc(it.spec || '')}</td>
          <td class="ar">×${it.qty}</td>
          <td class="ar">${money(it.price)}</td>
          <td class="ar">${money(sub)}</td>
          <td class="ar">
            <button type="button" class="rm-btn" onclick="removeItem(${i})" title="删除">
              <span class="sr-only">删除</span>🗑️
            </button>
          </td>
        </tr>`;
      }).join('');

      const subtotal = cart.reduce((a,b)=> a + b.qty*b.price, 0);
      const baseShipping = getShippingFee();

      // ★ 计算促销
      const {discount, shipping, grand, lines} = calcPromo(subtotal, baseShipping);

      const method   = getShipMethod() === 'pickup' ? 'Pickup' : 'Delivery';
      const addr     = document.getElementById('custAddr').value.trim();

      const promoLines = lines.length
        ? `<div class="promo-lines" style="margin-top:6px;">
             <div style="color:#9effa8;">· Promotions:</div>
             ${lines.map(txt => `<div style="color:#9effa8;">· ${esc(txt)}</div>`).join('')}
           </div>`
        : '';

      box.innerHTML = `
        <div class="os-head">Order Summary</div>
        <table>
          <thead>
            <tr>
              <th>Item</th><th>Spec</th>
              <th class="ar">Qty</th><th class="ar">Price</th><th class="ar">Subtotal</th>
              <th class="ar"> </th>
            </tr>
          </thead>
          <tbody>${rowsHtml || `<tr><td colspan="6" style="text-align:center;color:#aaa;padding:8px 0">Cart is empty</td></tr>`}</tbody>
        </table>
        <div class="os-total" style="flex-direction:column;gap:4px;align-items:flex-end">
          <div>Subtotal: ${money(subtotal)}</div>
          ${discount>0 ? `<div style="color:var(--err);font-weight:900;">Discount: -${money(discount)}</div>` : ``}
          <div>Shipping: ${money(shipping)}</div>
          <div style="font-weight:900">Total: ${money(grand)}</div>
        </div>
        ${promoLines}
        <div class="os-meta" style="margin-top:8px;">
          <div>Method: ${method}</div>
          <div>Address: ${esc(addr)}</div>
        </div>
      `;
    }

    function openCheckout(){
      if(cart.length===0) return;
      onShipChange();
      renderOrderSummary();
      document.getElementById('checkoutBg').classList.add('active');
      document.body.classList.add('modal-open');
      if(!PROMO_RULES.length) loadPromos().catch(()=>{});
    }
    function closeCheckout(){
      document.getElementById('checkoutBg').classList.remove('active');
      document.body.classList.remove('modal-open');
    }

    function openTelegramLink(url, openedWindow){
      const ua = navigator.userAgent || '';
      const inTelegramWebView = /Telegram/i.test(ua);

      if (inTelegramWebView) { location.href = url; return; }
      if (openedWindow) {
        openedWindow.location.href = url;
      } else {
        const a = document.createElement('a');
        a.href = url; a.target = '_blank'; a.rel = 'noopener';
        document.body.appendChild(a); a.click(); a.remove();
      }
      setTimeout(()=>{ if (document.visibilityState === 'visible') { alert('如果没有自动打开 Telegram，请点击确认后再次尝试，或复制链接到 Safari 打开：\n' + url); } }, 800);
    }

    async function submitOrder(){
      const msg = document.getElementById('checkoutMsg');
      const name = document.getElementById('custName').value.trim();
      const phone= document.getElementById('custPhone').value.trim();
      const addr = document.getElementById('custAddr').value.trim();
      const notes= document.getElementById('custNotes').value.trim();
      const ship = getShipMethod();

      msg.className='checkout-msg'; msg.textContent='';
      if(!cart.length){ msg.className='checkout-msg err'; msg.textContent='Cart is empty'; return; }
      if(!name || !phone || !addr){ msg.className='checkout-msg err'; msg.textContent='Please fill in your name / phone number / address'; return; }
      if(cart.some(x => !x.price || x.price <= 0)){ msg.className='checkout-msg err'; msg.textContent='Some product prices are invalid, please refresh and try again'; return; }

      const subtotal = cart.reduce((a,b)=> a + b.qty*b.price, 0);
      const baseShipping = getShippingFee();
      const promoCalc = calcPromo(subtotal, baseShipping);

      const payload = {
        items: cart.map(x=>({name:x.name,spec:x.spec,price:x.price,qty:x.qty})),
        name, phone, address: addr, notes,
        delivery: ship,
        checkout: {
          subtotal,
          discount: Math.round(promoCalc.discount),
          shipping_fee: Math.round(promoCalc.shipping),
          total: Math.round(promoCalc.grand),
          promo_applied: promoCalc.promos.map(p=>({code:p.code||'', type:p.type, value:p.value, min:p.min, desc:p.desc, start:p.start||'', end:p.end||''}))
        }
      };

      const tgChatId = localStorage.getItem('tg_chat_id');
      if (!tgChatId) {
        msg.className = 'checkout-msg err';
        msg.innerHTML = 'Please bind Telegram before placing an order ' +
                        '<a href="#" onclick="bindTelegram();return false;">Bind Now</a>';
        return;
      }
      payload.tg_chat_id = tgChatId;

      try{
        const res = await fetch(`${API_BASE}/order`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
        const data = await res.json();
        if(res.ok){
          msg.className='checkout-msg ok';
          if (data.user_notified){
            msg.textContent = 'Order successful! You have been notified via Telegram.';
          } else if (data.tg_deeplink){
            msg.innerHTML = 'Order placed! Click here to receive this order in Telegram 👉 ' + `<a href="${data.tg_deeplink}" target="_blank" rel="noopener">Enable notifications</a>`;
          } else {
            msg.textContent = 'Order Successfully！';
          }
          cart.splice(0, cart.length); renderCartBar();
          document.getElementById('custName').value =
          document.getElementById('custPhone').value =
          document.getElementById('custAddr').value =
          document.getElementById('custNotes').value = '';
          document.getElementById('promoCodeInput').value = '';
          MANUAL_PROMO = null;
          setTimeout(closeCheckout, 1200);
        }else{
          msg.className='checkout-msg err';
          msg.textContent = data.error || 'Failed, please try again later';
        }
      }catch(e){
        msg.className='checkout-msg err';
        msg.textContent='Network Error, please try again later';
      }
    }

    // ======= One-click bind Telegram =======
    function isIOS(){ return /iP(hone|od|ad)/i.test(navigator.userAgent); }

    function addTgFallback(link){
      if(document.getElementById('tgFallback')) return;
      const div = document.createElement('div');
      div.id = 'tgFallback';
      div.style = 'margin-top:8px;text-align:center;color:#ffe02e;';
      div.innerHTML = `如果没有自动打开 Telegram，请 <a href="${link}" target="_blank" rel="noopener noreferrer">点这里</a> 手动打开。`;
      const holder = document.querySelector('[onclick*="bindTelegram"]')?.parentNode || document.body;
      holder.appendChild(div);
    }

    function openTelegramLinkSmart(link, preOpenedWin){
      if (isIOS()) {
        location.href = link;
        setTimeout(()=>addTgFallback(link), 800);
        return;
      }
      if (preOpenedWin) { try { preOpenedWin.location.href = link; return; } catch(e){} }
      let opened = false;
      try { const w = window.open(link, '_blank', 'noopener,noreferrer'); opened = !!w; } catch(e) { opened = false; }
      if (!opened) location.href = link;
      setTimeout(()=>addTgFallback(link), 800);
    }

    async function bindTelegram(){
      if (window._bindingRunning) return;
      window._bindingRunning = true;

      const needPreOpen = !isIOS();
      let pre = null;
      try{
        if (needPreOpen) pre = window.open('', '_blank');
        const r = await fetch(`${API_BASE}/bind/new`, {method:'POST'});
        const data = await r.json();

        if(!r.ok || !data.tg_deeplink){
          if (pre) pre.close();
          alert(data.error || 'Binding failed, please try again later');
          return;
        }
        openTelegramLinkSmart(data.tg_deeplink, pre);

        const code = data.code;
        const start = Date.now();
        const maxWait = 120000;
        const timer = setInterval(async ()=>{
          try{
            const rr = await fetch(`${API_BASE}/bind/status?code=${encodeURIComponent(code)}`);
            const s  = await rr.json();
            if (s.status === 'ok') {
              clearInterval(timer);
              localStorage.setItem('tg_chat_id', s.chat_id);
              alert('✅ Binding successful！');
              renderCartBar?.();
            }
          }catch(e){}
          if (Date.now() - start > maxWait) clearInterval(timer);
        }, 2000);

      }catch(e){
        if (pre) pre.close();
        alert('Binding failed, please try again later');
      }finally{
        window._bindingRunning = false;
      }
    }

    // Wire up radio events & initial states
    document.querySelectorAll('input[name="ship"]').forEach(el=> el.addEventListener('change', onShipChange));
    onShipChange();
    renderCartBar();
    // 预加载 PROMO
    loadPromos().catch(()=>{});

    // Expose
    window.addToCart = addToCart;
    window.openCheckout = openCheckout;
    window.closeCheckout = closeCheckout;
    window.submitOrder = submitOrder;
    window.bindTelegram = bindTelegram;
  </script>
</body>
</html>










